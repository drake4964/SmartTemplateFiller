# Quickstart: License Verification Feature

**Feature**: 001-license-verification  
**Audience**: Developers working on SmartTemplateFiller  
**Date**: 2026-01-28

## Overview

This guide helps developers understand and test the license verification feature locally.

---

## Development Setup

### 1. Disable License Checking for Local Development

Create or edit `license_config.json` in the project root:

```json
{
  "enabled": false,
  "errorMessage": "License validation failed. Contact your administrator.",
  "logoPath": null,
  "licenseFilePath": "./license.json"
}
```

**Result**: Application will skip license validation entirely.

---

### 2. Generate a Test License File

#### Option A: Use the LicenseGenerator Tool

```bash
# Build the license generator
cd tools/LicenseGenerator
../../gradlew.bat build

# Generate license for your machine
java -jar build/libs/LicenseGenerator.jar \
  --mac "00:1A:2B:3C:4D:5E" \
  --serial "YOUR_MOTHERBOARD_SERIAL" \
  --expiry "2027-12-31" \
  --output "../../license.json"
```

#### Option B: Manually Create a Test License

Extract your hardware IDs:
```bash
# Run SmartTemplateFiller with DEBUG logging enabled
# Check console output for extracted MAC addresses and serial number
```

Create `license.json` with your hardware:
```json
{
  "version": "1.0",
  "hardware": {
    "macAddresses": ["YOUR_MAC_HERE"],
    "motherboardSerial": "YOUR_SERIAL_HERE"
  },
  "expiry": "2027-12-31T23:59:59Z",
  "signature": "valid_signature_generated_by_tool"
}
```

**Note**: The signature MUST be generated by the LicenseGenerator tool using the embedded secret key. Manual signatures will fail validation.

---

## Testing Scenarios

### Scenario 1: Valid License (Happy Path)

**Setup**:
1. Set `license_config.json` → `"enabled": true`
2. Generate valid license file with your hardware IDs
3. Place `license.json` in project root

**Expected Behavior**:
- Application starts normally
- No error dialog appears
- Main window loads

**Verification**:
```bash
./gradlew.bat run
# Should see main window without any blocking dialogs
```

---

### Scenario 2: Missing License File

**Setup**:
1. Set `license_config.json` → `"enabled": true`
2. Delete or rename `license.json`

**Expected Behavior**:
- Error dialog appears with message: "Kindly contact Mitutoyo for more details."
- Application exits after closing dialog

**Verification**:
```bash
./gradlew.bat run
# Should see error dialog, then application closes
```

---

### Scenario 3: Expired License

**Setup**:
1. Edit `license.json` → Set `"expiry": "2020-01-01T00:00:00Z"` (past date)
2. **Regenerate signature** using LicenseGenerator tool

**Expected Behavior**:
- Error dialog appears
- Application exits

---

### Scenario 4: Hardware Mismatch

**Setup**:
1. Edit `license.json` → Change MAC address or serial to incorrect values
2. **Regenerate signature** using LicenseGenerator tool

**Expected Behavior**:
- Error dialog appears
- Application exits

---

### Scenario 5: Custom Error Message and Logo

**Setup**:
1. Edit `license_config.json`:
```json
{
  "enabled": true,
  "errorMessage": "Custom error message for testing!",
  "logoPath": "src/main/resources/test_logo.png",
  "licenseFilePath": "./license.json"
}
```
2. Place a test logo image at the specified path
3. Delete or invalidate `license.json`

**Expected Behavior**:
- Error dialog shows custom message
- Custom logo appears in upper left corner

---

## Unit Testing

### Running License Verification Tests

```bash
# Run all license module tests
./gradlew.bat test --tests "com.example.smarttemplatefiller.license.*"

# Run specific test class
./gradlew.bat test --tests "LicenseValidatorTest"

# View coverage report (requires JaCoCo plugin)
./gradlew.bat jacocoTestReport
# Open build/reports/jacoco/test/html/index.html
```

### Writing New Tests

Use `MockHardwareIdentifier` for controlled hardware simulation:

```java
@Test
public void testValidLicense() {
    // Arrange
    MockHardwareIdentifier mockHardware = new MockHardwareIdentifier(
        List.of("00:1A:2B:3C:4D:5E"),
        "ABC123456789"
    );
    LicenseValidator validator = new DefaultLicenseValidator(mockHardware);
    
    // Act
    ValidationResult result = validator.validate("test/fixtures/valid_license.json");
    
    // Assert
    assertTrue(result.isValid());
    assertEquals(ErrorCode.SUCCESS, result.getErrorCode());
}
```

---

## Debugging Tips

### Enable Debug Logging

Add to `MainApp.java` before validation:
```java
System.setProperty("license.debug", "true");
```

**Output**:
```
[License] Configuration loaded: enabled=true
[License] License file found: ./license.json
[License] Current MAC addresses: [00:1A:2B:3C:4D:5E, AA:BB:CC:DD:EE:FF]
[License] Current motherboard serial: ABC123456789
[License] HMAC validation: PASSED
[License] Hardware validation: PASSED
[License] Expiry validation: PASSED
[License] Validation result: SUCCESS
```

### Extract Your Hardware IDs

Run this temporary code in `MainApp.start()`:
```java
HardwareIdentifier identifier = new OshiHardwareIdentifier();
CurrentHardwareInfo hardware = identifier.getCurrentHardware();
System.out.println("Your MACs: " + hardware.getMacAddresses());
System.out.println("Your Serial: " + hardware.getMotherboardSerial());
```

---

## Deployment Workflow

### For End Users (Production)

1. **Build application** with license checking enabled (default `license_config.json`)
2. **Generate license** for customer's machine:
   ```bash
   java -jar LicenseGenerator.jar \
     --mac "CUSTOMER_MAC" \
     --serial "CUSTOMER_SERIAL" \
     --expiry "2026-12-31" \
     --output "license.json"
   ```
3. **Distribute** both `SmartTemplateFiller.exe` and `license.json` to customer
4. **Customer places** `license.json` in same directory as executable

### For Internal Testing/Development

1. Set `license_config.json` → `"enabled": false`
2. Distribute to QA team without license file requirement

---

## FAQ

**Q: How do I bypass license checking while developing?**  
A: Set `"enabled": false` in `license_config.json`.

**Q: How do I test license expiry without waiting?**  
A: Create a license with past `"expiry"` date, regenerate signature, and run application.

**Q: Can I use the same license file on multiple machines?**  
A: No, licenses are bound to specific MAC addresses and motherboard serials.

**Q: What if my network adapter changes?**  
A: Generate a new license file with the new MAC address.

**Q: How do I test on a virtual machine?**  
A: VMs have virtual MAC addresses; generate a license with the VM's virtual MAC.

---

## Related Documentation

- [spec.md](spec.md) - Feature specification
- [plan.md](plan.md) - Implementation plan
- [data-model.md](data-model.md) - Data structures
- [research.md](research.md) - Technical research
